# Test Fixtures 重构计划

## 背景

根据 QA 审计报告（`docs/qa/report/test_fixtures.md`），`tests/test_fixtures.py` 虽然测试功能完整（100% 通过率，48 个测试），但业务意图表达严重不清晰（24% 通过率）。

### 核心问题

| 维度 | 评分 | 状态 |
|------|------|------|
| 业务意图清晰度 | 2/10 | ❌ 不合规 |
| 层次匹配度 | 0/10 | ❌ 不合规 |
| 术语对齐 | 6/10 | ⚠️ 警告 |
| 抽象层级合适 | 2/10 | ❌ 不合规 |
| 业务可读性 | 2/10 | ❌ 不合规 |

**总分**: 12/50 (24%)

---

## 目标

### 主要目标
将业务意图表达从 24% 提升至 80% 以上，让业务人员能够理解并参与代码评审。

### 次要目标
1. 保持 100% 测试通过率
2. 创建可复用的领域模型库
3. 建立业务意图表达最佳实践

---

## 阶段规划

### 阶段一：领域模型设计与实现（预计 6 小时）

**优先级**: P0
**负责人**: 开发团队
**预计完成**: 2026-01-17

#### 1.1 设计领域模型（2 小时）

**目标**: 创建符合业务概念的领域模型

**任务清单**:
- [ ] 设计 `Workspace` 工作区模型
  - 组件完整性验证
  - 目录结构检查
- [ ] 设计 `BusinessArtifacts` 业务工件模型
  - Plan 验证
  - Schema 验证
  - Manifest 验证
- [ ] 设计 `DataPipeline` 数据流水线模型
  - Processor 可执行性验证
  - Inspector 功能验证
  - 数据质量验证
- [ ] 设计 `DataSchema` 数据结构模型
  - Schema 完整性验证
  - 字段定义验证
  - 类型约束验证
- [ ] 设计 `QualityReport` 质量报告模型
  - 报告章节完整性验证
  - 质量检查结果验证

**交付物**:
- 领域模型设计文档（`docs/design/domain_models.md`）
- 类图和关系图

#### 1.2 实现领域模型（4 小时）

**目标**: 编写可复用的领域模型代码

**任务清单**:
- [ ] 创建 `src/domain/` 目录
- [ ] 实现 `Workspace` 类
  ```python
  class Workspace:
      """工作区"""
      REQUIRED_COMPONENTS = ["plan", "schema", "processor", "inspector", "record", "report", "manifest"]

      def is_complete(self) -> bool:
          """工作区是否完整"""
          pass

      def validation_report(self) -> str:
          """验证报告"""
          pass
  ```
- [ ] 实现 `BusinessArtifacts` 类
- [ ] 实现 `DataPipeline` 类
- [ ] 实现 `DataSchema` 类
- [ ] 实现 `QualityReport` 类
- [ ] 编写领域模型单元测试

**交付物**:
- 领域模型代码（`src/domain/`）
- 领域模型测试（`tests/test_domain/`）

---

### 阶段二：测试重构（预计 6 小时）

**优先级**: P0
**负责人**: 开发团队
**预计完成**: 2026-01-18

#### 2.1 重构测试结构（2 小时）

**目标**: 代码层次直接映射业务层次

**任务清单**:
- [ ] 重新设计测试类结构
  ```python
  # 重构前
  class TestFixturesStructure:  # 技术视角
  class TestPlan:
  class TestSchema:

  # 重构后
  class TestWorkspace:           # 业务视角
      def test_workspace_complete(self):
      def test_business_artifacts_complete(self):
      def test_data_pipeline_complete(self)

  class TestBusinessArtifacts:
      def test_plan_clear(self):
      def test_schema_complete(self):
      def test_manifest_complete(self)
  ```
- [ ] 按业务概念组织测试
- [ ] 删除技术视角的测试类

**交付物**:
- 重构后的测试文件

#### 2.2 使用领域模型重写测试（4 小时）

**目标**: 用领域模型替代技术细节

**任务清单**:
- [ ] 重写 Workspace 测试
- [ ] 重写 BusinessArtifacts 测试
- [ ] 重写 DataPipeline 测试
- [ ] 重写 DataSchema 测试
- [ ] 重写 QualityReport 测试
- [ ] 确保所有测试通过

**交付物**:
- 使用领域模型的测试代码

---

### 阶段三：术语对齐与文档完善（预计 2 小时）

**优先级**: P1
**负责人**: 开发团队
**预计完成**: 2026-01-19

#### 3.1 业务术语词典（1 小时）

**目标**: 统一使用业务术语

**任务清单**:
- [ ] 创建业务术语词典（`docs/glossary.md`）
  ```markdown
  | 技术术语 | 业务术语 |
  |---------|---------|
  | exists | complete / available |
  | is_valid_json | well_formed |
  | has_required_fields | complete / well_defined |
  ```
- [ ] 替换测试方法名中的技术术语
- [ ] 替换类名中的技术术语
- [ ] 替换变量名中的技术术语

**交付物**:
- 业务术语词典
- 术语对齐后的代码

#### 3.2 文档完善（1 小时）

**目标**: 添加业务层级文档字符串

**任务清单**:
- [ ] 添加模块级业务说明文档字符串
- [ ] 添加类级业务说明文档字符串
- [ ] 添加方法级业务说明文档字符串
- [ ] 更新 README.md

**交付物**:
- 完善后的文档

---

### 阶段四：验证与优化（预计 2 小时）

**优先级**: P1
**负责人**: QA 团队
**预计完成**: 2026-01-19

#### 4.1 QA 重新审计（1 小时）

**目标**: 验证改进效果

**任务清单**:
- [ ] 运行 QA 审计流程
- [ ] 确认业务意图表达评分提升
- [ ] 记录改进前后对比

**交付物**:
- 新的 QA 审计报告

#### 4.2 业务人员评审（1 小时）

**目标**: 验证业务可读性

**任务清单**:
- [ ] 邀请业务人员评审代码
- [ ] 收集反馈意见
- [ ] 根据反馈微调

**交付物**:
- 业务评审反馈

---

## 任务分解

### P0 任务（必须完成）

| 任务ID | 任务名称 | 预计工时 | 负责人 | 状态 |
|--------|---------|---------|--------|------|
| TASK_001 | 设计领域模型 | 2h | 开发 | 待开始 |
| TASK_002 | 实现领域模型 | 4h | 开发 | 待开始 |
| TASK_003 | 重构测试结构 | 2h | 开发 | 待开始 |
| TASK_004 | 使用领域模型重写测试 | 4h | 开发 | 待开始 |
| **小计** | | **12h** | | |

### P1 任务（建议完成）

| 任务ID | 任务名称 | 预计工时 | 负责人 | 状态 |
|--------|---------|---------|--------|------|
| TASK_005 | 创建业务术语词典 | 1h | 开发 | 待开始 |
| TASK_006 | 替换技术术语 | 1h | 开发 | 待开始 |
| TASK_007 | 完善文档 | 1h | 开发 | 待开始 |
| TASK_008 | QA 重新审计 | 1h | QA | 待开始 |
| TASK_009 | 业务人员评审 | 1h | 业务 | 待开始 |
| **小计** | | **5h** | | |

---

## 风险与应对

### 风险1：领域模型设计不充分
**概率**: 中
**影响**: 高
**应对措施**:
- 在设计阶段邀请业务人员参与评审
- 使用原型验证领域模型的适用性

### 风险2：重构导致测试失败
**概率**: 低
**影响**: 高
**应对措施**:
- 逐步重构，每次只重构一个测试类
- 每次重构后立即运行测试
- 保持 Git 版本控制，可随时回滚

### 风险3：业务术语不统一
**概率**: 中
**影响**: 中
**应对措施**:
- 建立业务术语词典并强制使用
- 代码审查时检查术语使用

---

## 成功指标

### 量化指标
| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| 业务意图表达评分 | 12/50 (24%) | 40/50 (80%) |
| 测试通过率 | 100% | 100% |
| 业务可读性评分 | 2/10 | 8/10 |
| 层次匹配度评分 | 0/10 | 8/10 |

### 定性指标
- 业务人员能够理解和评审测试代码
- 新人可以通过代码理解业务意图
- 业务变更时能快速定位相关代码

---

## 里程碑

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M1: 领域模型完成 | 2026-01-17 | 领域模型代码和文档 |
| M2: 测试重构完成 | 2026-01-18 | 重构后的测试代码 |
| M3: 术语对齐完成 | 2026-01-19 | 术语词典和更新文档 |
| M4: 验收通过 | 2026-01-19 | QA 审计报告和业务评审反馈 |

---

## 资源需求

### 人力资源
- 开发工程师: 2 人 × 1.5 天 = 3 人天
- QA 工程师: 1 人 × 0.5 天 = 0.5 人天
- 业务评审人员: 1 人 × 0.5 天 = 0.5 人天

### 总工时
- 开发: 14 小时
- QA: 1 小时
- 业务评审: 1 小时
- **总计**: 16 小时（约 2 个工作日）

---

## 附录

### A. 参考资料
- QA 审计报告: `docs/qa/report/test_fixtures.md`
- 业务意图清晰度规则: `docs/qa/criteria/business_intent_clarity.md`

### B. 模板文件
- 领域模型设计模板: `docs/templates/domain_model.md`
- 测试重构检查清单: `docs/checklists/test_refactoring.md`

### C. 沟通计划
- 每日站会: 同步进度和问题
- 阶段评审会: 每个阶段完成后
- 最终验收会: 所有任务完成后
