# 产品需求文档

## 工作流程总结

### 阶段 1：理解审计框架基础
1. **定义核心概念**（docs/spec/README.md）
   - 审计规则（Audit Rule）
   - 审计规划（Audit Plan）
   - 审计问题（Audit Issue）
   - 审计报告

### 阶段 2：创建初始审计规则
2. **Python 代码质量规则**（tests/fixtures/rule/python_code_quality.md）
   - 9 条规则：复杂度、重复率、函数长度、类长度、模块大小、嵌套深度、参数数量、方法数量、魔法数字

3. **元审计规则**（第一版 - 过于复杂）
   - 15 条规则，包含团队评审、误报率测试、优先级分级等过度设计

### 阶段 3：发现问题并重构
4. **发现元审计规则问题**
   - 过于复杂，假设了团队评审等不现实的条件
   - 缺乏通用性，只适用于技术规则

5. **简化元审计规则**（tests/fixtures/rule/meta.md）
   - 从 15 条简化为 5 条核心规则
   - 4 个检查维度：完整性、可理解性、可执行性
   - 引入渐进式成熟度（基础→可用→完善）

### 阶段 4：创建审计程序
6. **元审计程序**（tests/fixtures/procedure/meta.md）
   - PROC_META_001：元审计规则质量审计

7. **Python 代码质量审计程序**（tests/fixtures/procedure/python_code_quality.md）
   - PROC_PY_CODE_001：包含 9 项检测，一键执行脚本

### 阶段 5：实际应用审计
8. **审计 Python 代码质量规则**
   - 使用元审计规则自审
   - 结果：100% 通过，规则质量优秀

9. **审计 qtcloud_data_test_fixtures.py**
   - 使用 Python 代码质量规则
   - 结果：94% 通过，代码质量优秀
   - **但用户发现问题**：代码虽然质量好，但业务意图不清晰

### 阶段 6：发现新需求，创建新规则
10. **创建业务意图表达清晰度规则**（tests/fixtures/rule/business_intent_clarity.md）
    - 5 条规则：业务意图清晰度、层次匹配度、术语对齐、抽象层级合适、业务可读性
    - 从"代码正确性"转向"代码表达"

11. **审计新规则**
    - 使用元审计规则审计
    - 结果：100% 通过，规则质量优秀

12. **重新审计 qtcloud_data_test_fixtures.py**
    - 使用业务意图表达清晰度规则
    - 结果：**24% 通过**，严重不合规
    - **关键洞察**：代码质量优秀（94%）≠ 业务意图清晰（24%）

---

## 核心成果

### 1. 审计框架体系
```
docs/spec/README.md (概念定义)
    ↓
tests/fixtures/rule/
    ├── meta.md (元审计规则 - 评估规则本身)
    ├── python_code_quality.md (Python 代码质量规则)
    └── business_intent_clarity.md (业务意图表达规则)
    ↓
tests/fixtures/procedure/
    ├── meta.md (元审计程序)
    └── python_code_quality.md (Python 代码质量审计程序)
    ↓
tests/fixtures/finding/
    ├── python_code_quality.md (审计发现)
    ├── qtcloud_data_test_fixtures.md (代码质量审计)
    └── qtcloud_business_intent.md (业务意图审计)
```

### 2. 三层审计体系
- **元审计**：评估审计规则本身的质量
- **代码质量审计**：评估代码的技术质量
- **业务意图审计**：评估代码的业务表达

### 3. 关键洞察
**"代码写得对" ≠ "代码说得清"**

- 代码质量审计：确保代码写得对
- 业务意图审计：确保代码说得清
- 两者互补，缺一不可

---

## 工作流程模式

### 标准审计流程
```
1. 创建/完善审计规则
    ↓
2. 使用元审计规则验证规则质量
    ↓
3. 创建审计程序
    ↓
4. 执行审计
    ↓
5. 生成审计发现
    ↓
6. 闭环改进
```

### 演进式流程
```
发现问题 → 创建新规则 → 验证规则 → 应用审计 → 发现新问题 → 创建新规则...
```

---

## 经验教训

1. **元审计规则应最小化**：避免过度设计，只保留核心要求
2. **业务视角与技术视角分离**：代码质量优秀不代表业务意图清晰
3. **审计规则应该是渐进式**：可以分阶段完善（基础→可用→完善）
4. **实际应用驱动规则完善**：通过真实审计发现规则的不足

审计需求
- 验证了框架的实用性和可扩展性